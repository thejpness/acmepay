---
/** Keep frontmatter JS-only to avoid TS diagnostics */
const { id = 'theme-toggle' } = Astro.props;
---

<button
  id={id}
  data-theme-toggle
  type="button"
  class="glass inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm aria-pressed:opacity-80"
  aria-pressed="false"
  aria-label="Toggle colour theme"
>
  <span class="iconify" data-icon="lucide:sun" aria-hidden="true"></span>
  <span class="sr-only">Toggle colour theme</span>
</button>

<script is:inline>
(() => {
  'use strict';
  const buttons = Array.from(document.querySelectorAll('[data-theme-toggle]'));
  if (buttons.length === 0) return;

  const getStoredTheme = () => {
    try { return localStorage.getItem('theme'); } catch { return null; }
  };

  const currentTheme = () =>
    document.documentElement.classList.contains('dark') ? 'dark' : 'light';

  const updateButtons = (next) => {
    buttons.forEach((btn) => {
      btn.setAttribute('aria-pressed', String(next === 'dark'));
      const icon = btn.querySelector('.iconify');
      if (icon) icon.setAttribute('data-icon', next === 'dark' ? 'lucide:moon' : 'lucide:sun');
    });
  };

  const applyTheme = (theme) => {
    const next = theme === 'dark' ? 'dark' : 'light';
    document.documentElement.classList.toggle('dark', next === 'dark');
    try { localStorage.setItem('theme', next); } catch {}
    updateButtons(next);
  };

  // init
  applyTheme(getStoredTheme() ?? currentTheme());

  buttons.forEach((button) => {
    button.addEventListener('click', () => {
      applyTheme(currentTheme() === 'dark' ? 'light' : 'dark');
    });
  });
})();
</script>
