---
/**
 * Posts to /api/subscribe with simple honeypot + aria-live feedback
 */
const id = 'nl';
---

<form
  class="gradient-border glass surface-alt rounded-3xl space-y-4 p-6 md:p-8"
  method="post"
  action="/api/subscribe"
>
  <div class="sr-only" aria-hidden="true">
    <label for={`${id}-hp`}>Leave this field blank</label>
    <input id={`${id}-hp`} name="company" type="text" tabindex="-1" autocomplete="off" />
  </div>

  <div class="space-y-2">
    <label class="block text-xs uppercase tracking-[0.3em] text-white/60" for={`${id}-email`}>Work email</label>
    <div class="flex flex-col gap-3 sm:flex-row">
      <input
        id={`${id}-email`}
        name="email"
        type="email"
        required
        class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-base text-white/90 placeholder:text-white/40 focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        placeholder="you@productteam.co.uk"
        inputmode="email"
      />
      <button
        type="submit"
        class="inline-flex w-full items-center justify-center rounded-2xl px-5 py-3 text-sm font-semibold text-white transition sm:w-auto disabled:opacity-60 disabled:cursor-not-allowed"
        style="background:var(--grad-accent)"
      >
        Subscribe to updates
      </button>
    </div>
  </div>

  <p id={`${id}-status`} class="text-sm" role="status" aria-live="polite"></p>
</form>

<script is:inline>
  const form = document.currentScript?.previousElementSibling;
  const status = form?.querySelector('[role="status"]');
  const submitButton = form?.querySelector('button[type="submit"]');

  const setStatus = (message, tone = 'muted') => {
    if (!status) return;
    status.textContent = message;
    status.classList.remove('text-emerald-400', 'text-rose-400', 'text-white/60');
    const toneClass = tone === 'success' ? 'text-emerald-400' : tone === 'error' ? 'text-rose-400' : 'text-white/60';
    status.classList.add(toneClass);
  };

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!(form instanceof HTMLFormElement)) return;

    submitButton?.setAttribute('disabled', 'true');
    setStatus('Submitting your details...');

    try {
      const response = await fetch(form.action, { method: 'POST', body: new FormData(form) });
      const payload = await response.json().catch(() => ({}));

      if (response.ok) {
        setStatus('Thank you. Please check your inbox for confirmation.', 'success');
        form.reset();
      } else {
        setStatus(payload?.message ?? 'Something went wrong. Please try again.', 'error');
      }
    } catch {
      setStatus('Network error. Please try again.', 'error');
    } finally {
      submitButton?.removeAttribute('disabled');
    }
  });
</script>
